# Gif 图结构

Gif 是基于颜色列表实现的，**像素点位置储存的是该点对应的颜色在颜色列表中的索引值**，最多支持 8 位（256色）。

它的数据结构由三个部分组成：**File Header（文件头）**、**Gif Data Stream（Gif 数据流）**、**文件终结器（Trailer）**。


## File Header 文件头

包含 GIF 的署名和版本号。

署名是用来标识文件是否为 Gif 格式，由三个字符组成 `GIF`。

版本号通常有三个字节，通常为 `87a` 或者 `89a`。  

下图为 gif 文件的 16 进制数据：

![](https://gw.alicdn.com/tfs/TB1F2wwqTM11u4jSZPxXXahcXXa-980-178.png)

前面的 `47494638 3961` 转换为文本就是 **GIF89a**。

通过署名，可以判断数据文件是不是 Gif。


## Gif Data Stream Gif数据流

### 1.逻辑屏幕标识符

由 7 个字节组成，定义了 Gif 图的基本参数：
- 大小，其中 1～2 字节定义 Gif 图的宽度，3 ～ 4 字节定义 Gif 图的高度
- 有无全局颜色列表，第 5 字节展开，第 1 位标识是否有全局
- 颜色深度，第 5 字节展开, 第 2～4 位表示颜色占用的 Bit 数
- 排列方式，第 5 字节展开，第 5 位表示颜色排列方式（1表示按出现频率排序）
- 全局颜色列表大小，第 5 字节展开，第 6 ～ 8 位表示全局颜色列表大小，2^(N+1)
- 背景色，6 字节表示背景色在全局颜色列表中的索引值，没有颜色列表，该值无效
- 像素高宽比，7 字节表示gif高宽比，大多数时候为0

比如在 `0A00 0A00B300 00`：

- `0A00 0A00` 表示Gif图大小为 10x10
- `B3` 展开为 `10110011`
    - 1，表示有全局颜色列表
    - 011，表示一个颜色占用3个字节
    - 0，排列方式按出现顺序排
    - 011，表示颜色列表大小为16
- `00` 背景颜色索引为 0
- `00` 像素高宽比为 0

### 2.全局颜色列表

在逻辑屏幕标识符之后，就是颜色列表了，按照 RGB 的顺序排列。

### 3.扩展块

Gif 中的扩展块都是以 `0x21` 开始的，后面紧跟一个用于标识扩展用途的字节。

扩展块包括 **应用程序控制扩展** 和 **图形程序控制扩展**。

#### 3.1 应用程序控制扩展

标识字节为 `0xFF`。

总长为 19 个字节，包含了应用程序的标识信息和应用程序数据。

- 第 1～2 字节，扩展标识，`21FF`
- 第 3 字节，应用程序信息大小，通常大小为 11
- 第 4～14 字节，应用程序信息，“NETSCAPE2.0”
- 第 15～16 字节，应用程序数据大小
- 第 17～18 字节，数据
- 第 19 字节，结束符，`00`

#### 3.2 图形控制扩展

标识字节为 `0xF9`。

总长为 8 个字节，用于放在一个图像块前，控制跟在它后面的第一个图像。

- 第 1～2 字节，扩展标识，`21F9`
- 第 3 字节，表示此处到块结束符号之间的数据大小，通常固定值为 4，即 `04`
- 第 4 字节，压缩字节：
    - 1～3 bit 是保留位
    - 4～6 bit 表示处置方法，diposal method
        - 0，表示不使用处置方法
        - 1，不清理画布，直接绘制下一图像
        - 2，清理画布，再绘制下一图像
        - 3，将画布设置为上一状态，再绘制下一图像
- 第 5～6 字节，表示图像的动画时间，单位为 `1/100s`
- 第 7 字节，透明色索引
- 第 8 字节，标识块结束，固定为 `00`

比如在 `21F9 04 09 3200 0F 00`:
- `21F9`，表示是图像控制扩展
- `04`，扩展块大小为 4
- `09`，压缩字节
- `32 00`，表示暂停多长时间后，再往下处理数据流
- `0F`，透明色索引
- `00`，块结束符号



### 图像标识符

在图像数据前，由 `0x2C` 开始，长度为 10 个字节。

- 第 1 字节，标识
- 第 2～9 字节，分别表示 left、top、width、height
- 第 10 字节，压缩字节：
    - 2 Bit，表示图像的储存方式，**交织** 还是 **连续**


### 基于颜色列表的图像数据

由 LZW 编码长度和图像数据组成。

图像数据在压缩前有两种排列格式（在图像标识符中定义）：

- 连续：按照从左到右，从上到下排列
- 交织：
    - 第一通道a，从第0行开始，每隔8行提取
    - 第二通道r，从第4行开始，每隔8行提取
    - 第三通道g，从第2行开始，每隔4行提取
    - 第四通道b，从第1行开始，每隔2行提取

## 文件终结

以 `0x3B` 标识文件结束。


