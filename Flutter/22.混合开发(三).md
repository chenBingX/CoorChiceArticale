[![](https://raw.githubusercontent.com/chenBingX/img/master/Flutter/Flutterå¿«é€Ÿä¸Šæ‰‹æŒ‡å—å°é¢2.JPG)](https://juejin.im/post/5c8f8e62e51d456a0f23d0fe)

[**ç›®å½•ä¼ é€é—¨ï¼š**ã€ŠFlutterå¿«é€Ÿä¸Šæ‰‹æŒ‡å—ã€‹å…ˆå¯¼ç¯‡](https://juejin.im/post/5c8f8e62e51d456a0f23d0fe)


é€šè¿‡é˜…è¯» [æ··åˆå¼€å‘(ä¸€)]() å’Œ [æ··åˆå¼€å‘(äºŒ)]() ï¼Œç›¸ä¿¡ä½ å·²ç»è®©ä¸€ä¸ª **åŸç”Ÿ + Flutetr** çš„æ··åˆåº”ç”¨è¿è¡Œèµ·æ¥äº†ã€‚

æ­å–œä½  ğŸ‰ğŸ‰ğŸ‰ï¼

ç°åœ¨ï¼Œä½ å¯èƒ½é‡åˆ°äº† Flutterä»£ç  å’Œ åŸç”Ÿä»£ç  ä¹‹å‰æ— æ³•äº’ç›¸è°ƒç”¨çš„éš¾é¢˜ã€‚

å› ä¸º Flutter ä½œä¸ºç‹¬ç«‹äºåŸç”Ÿ Android çš„ä¸€å¥—å¼€å‘æ¡†æ¶ï¼Œè‚¯å®šæ˜¯ä¸èƒ½ç›´æ¥äº’ç›¸è°ƒç”¨å’Œæ„‰å¿«çš„äº¤æ¢ä¿¡æ¯çš„ã€‚

ç°åœ¨ï¼Œæ¥çœ‹çœ‹ Flutter æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚  


# 1.Platform Channels

Flutter ä½¿ç”¨ **Platform Channels** æ¶æ„æ¥å®ç° Flutter å’Œ åŸç”Ÿ ä¹‹é—´çš„é€šä¿¡ã€‚  

![](https://raw.githubusercontent.com/chenBingX/img/master/Flutter/Flutteré€šä¿¡1.png)  

ä¸Šå›¾æ˜¯å…¶ä¸­ MethodChannel çš„æ¶æ„ç¤ºæ„å›¾ï¼ŒFlutter å¯ä»¥é€šè¿‡ MethodChannel å¼‚æ­¥çš„å‘é€å’Œæ¥æ”¶ä¿¡æ¯ã€‚  

MethodChannel æ˜¯ç»è¿‡å°è£…çš„æ¯”è¾ƒæ–¹ä¾¿çš„é€šä¿¡æ–¹å¼ï¼ŒFlutter å®˜ç½‘çš„ä¾‹å­ä¹Ÿæ˜¯é€šè¿‡ MethodChannel æ¥å®ç°çš„ã€‚  

Platform Channels ä»…å…è®¸ä»¥ä¸‹å‡ ç§çš„æ•°æ®ç±»å‹åœ¨é€šä¿¡ä¸­ä½¿ç”¨ï¼š

|Dart|Android|iOS|
|---|---|---|
|null|null|nil (NSNull when nested)|
|bool|java.lang.Boolean|NSNumber numberWithBool|
|int|java.lang.Integer|NSNumber numberWithInt|
|int, if 32 bits not enough|java.lang.Long|NSNumber numberWithLong|
|double|java.lang.Double|NSNumber numberWithDouble|
|String|java.lang.String|NSString|
|Uint8List|byte[]|FlutterStandardTypedData typedDataWithBytes|
|Int32List|int[]|FlutterStandardTypedData typedDataWithInt32|
|Int64List|long[]|FlutterStandardTypedData typedDataWithInt64|
|Float64List|double[]|FlutterStandardTypedData typedDataWithFloat64|
|List|java.util.ArrayList|NSArray|
|Map|java.util.HashMap|NSDictionary|


# 2.å¦‚ä½•ä½¿ç”¨ MethodChannel 

MethodChannel é€šè¿‡ç‰¹å®šçš„é€šé“ï¼Œæ¥å»ºç«‹èµ· Flutter å’Œ Native ä¹‹é—´é€šä¿¡æ¡¥æ¢ã€‚  

å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Flutter å’Œ Native ä¸¤ç«¯éƒ½éœ€è¦å®šä¹‰ç›¸åŒçš„é€šé“ã€‚  

## 2.1 ç¬¬ä¸€æ­¥ï¼šå®šä¹‰é€šä¿¡é€šé“

- Flutter ç«¯ï¼š 
  
  å…ˆå¯¼å…¥ `import 'package:flutter/services.dart';` åŒ…ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª MethodChannelã€‚
  
  ```dart
  
  const channel = MethodChannel('foo');

  ```
  
- Native - Android ç«¯ï¼š  

  ```java
  MethodChannel channel = new MethodChannel(flutterView, "foo");
  ```

- Native - iOS ç«¯ï¼š  
  
  ```
  let channel = FlutterMethodChannel(
    name: "foo", binaryMessenger: flutterView)
  ```
  

å»ºç«‹ä¸€ä¸ªé€šä¿¡é€šé“çš„æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦ä½¿ç”¨ç›¸åŒçš„åç§°ï¼ˆæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„ `"foo"`ï¼‰åˆ›å»º **MethodChannel** å°±è¡Œã€‚  

åœ¨ä¸€ä¸ªå¤§å‹çš„é¡¹ç›®ä¸­ã€‚ä½ å¯èƒ½ä¼šéœ€è¦å»ºç«‹å¾ˆå¤šçš„é€šä¿¡é€šé“ï¼Œæ‰€ä»¥å»ºè®®ç»Ÿä¸€çš„ç®¡ç†è¿™äº›é€šä¿¡é€šé“ã€‚  

## 2.2 Flutter to Native

å»ºç«‹å¥½é€šä¿¡é€šé“ï¼Œæ¥çœ‹çœ‹å¦‚ä½•è®© Flutter ä¸»åŠ¨å’Œ Native é€šä¿¡ã€‚  

- Flutter ç«¯ï¼š

  ```dart
  final String greeting = await channel.invokeMethod('bar', 'world');
  print(greeting);
  ```
  
  é€šè¿‡ `invokeMethod(<æ ‡è¯†>, <æ•°æ®>)` å‡½æ•°å¯ä»¥ä¸»åŠ¨å‘èµ·å’Œ Native çš„ä¸€æ¬¡é€šä¿¡ï¼Œä¸”èƒ½å¤Ÿè·å¾—å“åº”ï¼Œå…è®¸çš„æ•°æ®ç±»å‹å°±æ˜¯å‰é¢è¡¨æ ¼ä¸­åˆ—å‡ºçš„æ•°æ®ç±»å‹ã€‚  
  
  å½“ç„¶ï¼Œä¸ºäº†ä¸é˜»å¡ UIï¼Œä½ éœ€è¦åœ¨å¼‚æ­¥ä¸­è¿›è¡Œã€‚  
  
- Native - Android ç«¯ï¼š
  
  ```java
  channel.setMethodCallHandler((methodCall, result) -> {
      if (methodCall.method.equals("bar")) {
          result.success("success, " + methodCall.arguments);
      }
  });
  ```
  
  åœ¨ Native ç«¯ï¼Œé€šè¿‡ä¸º MethodChannel è®¾ç½®ä¸€ä¸ªå¤„ç†å™¨ **MethodCallHandler**ã€‚  
  
  å½“ Flutter å‘ Native å‘èµ·é€šä¿¡æ—¶ï¼Œèƒ½å¤Ÿå›è°ƒå¤„ç†å™¨ä¸­çš„ `onMethodCall()` å‡½æ•°ã€‚  
  
  åœ¨è¯¥å›è°ƒä¸­ï¼Œèƒ½å¤Ÿé€šè¿‡ **MethodCall** è·å– Flutter å‘é€è¿‡æ¥çš„ä¿¡æ¯ï¼Œé€šè¿‡ **MethodChannel.Result** æ¥å‘ Flutter å‘é€å“åº”ç»“æœã€‚  
  
  
- Native - iOS ç«¯ï¼š
  
  
  ```
  channel.setMethodCallHandler {
    (call: FlutterMethodCall, result: FlutterResult) -> Void in
    switch (call.method) {
    case "bar": result("Hello, \(call.arguments as! String)")
    default: result(FlutterMethodNotImplemented)
    }
  }
  ```
  
## 2.3 Native to Flutter

- Flutter ç«¯ï¼š

    è®¾ç½®æ¥æ”¶ Native ä¿¡æ¯çš„å¤„ç†å™¨ï¼š

    ```
    channel.setMethodCallHandler((MethodCall call) async {
      switch (call.method) {
        case 'bar':
          return 'Hello, ${call.arguments}';
        case 'baz':
          throw PlatformException(code: '400', message: 'This is bad');
        default:
          throw MissingPluginException();
      }
    })
    ```

    é€šè¿‡ `setMethodCallHandler` å‡½æ•°è®¾ç½®ä¸€ä¸ª `Future<dynamic> handler(MethodCall call)` å‡½æ•°ã€‚

    è¯¥å‡½æ•°ä¼šåœ¨æ¥æ”¶åˆ° Native ä¿¡æ¯æ—¶è¢«è°ƒç”¨ï¼Œä» **MethodCall** ä¸­èƒ½å¤Ÿè·å¾— Native å‘é€è¿‡æ¥çš„æ•°æ®ã€‚

    æœ€åçš„ `return` ç¯èŠ‚å¯ä»¥è¿”å›æ•°æ®ç»™ Nativeã€‚

  
- Native - Android ç«¯ï¼š

    ```
    channel.invokeMethod("bar", "message", new MethodChannel.Result
        @Override
        public void success(@Nullable Object o) {
            // å‘é€æˆåŠŸæ—¶å›è°ƒ
        }
        @Override
        public void error(String s, @Nullable String s1, @Nullable
            // å‘é€å¤±è´¥æ—¶å›è°ƒ
        }
        @Override
        public void notImplemented() {
            // å¦‚æœè¯¥é€šé“åœ¨Flutterç«¯æœªå®ç°ï¼Œä¼šå›è°ƒè¿™é‡Œ
        }
    });
    ```

    ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Flutter ç«¯é€šè¿‡ `call.method` è·å¾—çš„æ ‡ç¤ºã€‚

    ç¬¬äºŒä¸ªå‚æ•°æ˜¯éœ€è¦å‘é€çš„æ•°æ®ã€‚

    ç¬¬ä¸‰ä¸ªå‚æ•°ç”¨äºç›‘å¬é€šä¿¡æ˜¯å®ŒæˆçŠ¶æ€ã€‚


- Native - iOS ç«¯ï¼š

    ```
    channel.invokeMethod(name, arguments: value) {
      (result: Any?) -> Void in
      if let error = result as? FlutterError {
        os_log("%@ failed: %@", type: .error, name, error.message!)
      } else if FlutterMethodNotImplemented.isEqual(result) {
        os_log("%@ not implemented", type: .error, name)
      } else {
        os_log("%@", type: .info, result as! NSObject)
      }
    }
    ```



