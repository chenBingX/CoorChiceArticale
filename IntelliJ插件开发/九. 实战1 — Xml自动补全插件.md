# ä¹. å®æˆ˜1 â€” Xmlè‡ªåŠ¨è¡¥å…¨æ’ä»¶
åœ¨ AndroidStudio ä¸­ï¼Œå¼€å‘è€…ä»¬ç¡®å®è·å¾—äº†xmlæç¤ºå’Œè‡ªåŠ¨è¡¥å…¨æ’ä»¶çš„å¥½å¤„ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€äº›æ ‡ç­¾ï¼Œå¦‚ä½•å¼€å‘ä¸€æ¬¾æ’ä»¶ï¼Œè®©å®ƒæ”¯æŒæç¤ºå’Œè‡ªåŠ¨è¡¥å…¨æˆ‘ä»¬è‡ªå®šä¹‰çš„æ ‡ç­¾ã€å±æ€§å‘¢ï¼Ÿæœ¬ç¯‡å°†ä¼šä¸€æ­¥ä¸€å»å®ç°è¿™ä¸ªæ’ä»¶ã€‚  

# 1. è¯¥ä»å“ªå¼€å§‹å…¥æ‰‹
é¦–å…ˆï¼Œç”±äºæˆ‘ä»¬å·²ç»äº«å—åˆ°äº† IDEA ä¸­xmlæç¤ºå’Œè‡ªåŠ¨è¡¥å…¨çš„åŠŸèƒ½ï¼Œè¯´æ˜ç³»ç»Ÿå·²ç»å¼€å‘å¥½äº†ç›¸å…³çš„æ’ä»¶ï¼Œå¦‚æœç³»ç»Ÿæä¾›äº†ä¸€äº› Extension Point é‚£å°±å¤ªæ£’äº†ï¼æ‰€ä»¥æˆ‘ä»¬å…ˆå»æ‰¾æ‰¾çœ‹ã€‚  

ä»ä½•æ‰¾èµ·ï¼Ÿå…ˆè¿›å…¥ä¸‹é¢é¡µé¢æŸ¥æ‰¾ä¸xmlç›¸å…³çš„é…ç½®æ–‡ä»¶ï¼š  

- [ã€æµ·é‡çš„æ’ä»¶æ‰©å±•ç‚¹ä½ã€‘](https://upsource.jetbrains.com/idea-ce/structure/idea-ce-d00d8b4ae3ed33097972b8a4286b336bf4ffcfab/platform/platform-resources/src/META-INF)  

å¾ˆå¿«ï¼Œä½ å°±èƒ½å¤Ÿå‘ç°ä¸€ä¸ªåä¸º `XmlPlugin.xml` çš„æ’ä»¶é…ç½®æ–‡ä»¶ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬è¦æ‰¾çš„å°±æ˜¯å®ƒã€‚

![](https://gw.alicdn.com/tfs/TB1VSdqox9YBuNjy0FfXXXIsVXa-440-720.png)  

æ‰“å¼€è¿™ä¸ªxmlæ–‡ä»¶åï¼Œä¼šçœ‹åˆ°å¯†å¯†éº»éº»çš„ `extensionPoint` æ ‡ç­¾ï¼Œæˆ‘ä»¬æ ¹æ®éœ€æ±‚çš„å…³é”®å­—ä½¿ç”¨æœç´¢åŠŸèƒ½åŒºè¿‡æ»¤å°±å¥½ã€‚  

ä¸¾ä¸ªæ —å­ğŸŒ°ã€‚  

æˆ‘ä»¬å¸Œæœ› IDEA çš„ xml ç¼–è¾‘å™¨ä¸­èƒ½å¤Ÿè‡ªåŠ¨æç¤ºæˆ‘ä»¬è‡ªå®šä¹‰çš„æ ‡ç­¾ï¼Œé‚£ä½¿ç”¨ `Tag` å…³é”®å­—å»æœç´¢å°±å¥½äº†ã€‚  

![](https://gw.alicdn.com/tfs/TB1xrM_oeuSBuNjy1XcXXcYjFXa-1529-713.png)  

æœ‰æ—¶å€™å¯èƒ½æœç´¢ç»“æœå¾ˆå¤šï¼Œä½†æ˜¯æ²¡åŠæ³•ï¼Œåªèƒ½ä¸€ä¸ªä¸ªæ’é™¤ã€‚æœ€ç»ˆé”å®šäº† `XmlTagNameProvider` è¿™ä¸ªæ‰©å±•ç‚¹ã€‚ä¸ºä»€ä¹ˆæ˜¯å®ƒå‘¢ï¼Ÿå› ä¸ºå®ƒè¿™ä¸ªå‘½åå®åœ¨å¤ªæ‹›æ‘‡è¿‡å¸‚äº†ï¼å¥½åƒåœ¨å¤§å£°å–Šç€ï¼Œâ€œå¦‚æœä½ è¦è®©ä½ çš„xmlç¼–è¾‘å™¨èƒ½å¤Ÿè‡ªåŠ¨æç¤ºè‡ªå®šä¹‰æ ‡ç­¾ï¼Œä½ å°±è¯¥åˆ°æˆ‘è¿™æ¥è¯•è¯•ã€‚â€œ    

ç°åœ¨æˆ‘ä»¬ä»ç„¶è¿·æƒ‘äºå¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ‰©å±•ç‚¹ï¼Œå¦‚æœæœ‰äº›æ —å­æŒ‡ç‚¹è¿·æ´¥é‚£å°±å¤ªåˆæˆ‘ä»¬æ„äº†ã€‚  

æ²¡é—®é¢˜ï¼é€‰ä¸­è¯¥æ‰©å±•ç‚¹çš„æ¥å£ç±»ï¼Œèƒ½å¤Ÿçœ‹åˆ°å¦‚ä¸‹å¯¹è¯æ¡†ï¼Œé€‰æ‹© `Search for Selection` å°±èƒ½æœç´¢åˆ°ç›¸å…³çš„æ —å­ğŸŒ°äº†ã€‚  

![](https://gw.alicdn.com/tfs/TB1uUAHoXOWBuNjy0FiXXXFxVXa-811-421.png)  

è¿™æ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„æœ€å¥½çš„æ —å­ğŸŒ°ã€‚  

![](https://gw.alicdn.com/tfs/TB1aJ8yoxGYBuNjy0FnXXX5lpXa-1053-662.png)

# 2. è®©Xmlç¼–è¾‘å™¨èƒ½å¤Ÿæç¤ºè‡ªå®šä¹‰æ ‡ç­¾

æ˜¾ç„¶ï¼Œä¸Šé¢çš„æ —å­ä¸­æˆ‘ä»¬å·²ç»æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„ç›®æ ‡æ‰©å±•ç‚¹ `XmlTagNameProvider` ï¼Œæ¥ä¸‹æ¥åªè¦å®ç°å®ƒï¼Œç„¶åå†åˆ° `plugin.xml` ä¸­æ³¨å†Œä¸€ä¸‹å°±å¥½ã€‚  

## 2.1 å®ç° XmlTagNameProvider æ¥å£

åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è‡ªå®šä¹‰æ ‡ç­¾åªæœ‰åœ¨æŒ‡å®šç›®å½•ä¸‹çš„xmlæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”åªæœ‰å½“çˆ¶çº§æ ‡ç­¾ä¸ºæŒ‡å®šæ ‡ç­¾æ—¶æ‰å‡ºç°æç¤ºã€‚  

```
public class SimpleXmlTagNameProvider implements XmlTagNameProvider {

    @Override
    public void addTagNameVariants(List<LookupElement> list, @NotNull XmlTag xmlTag, String s) {
        // è·å¾—åŒ…å«è¯¥Tagçš„æ–‡ä»¶
        PsiFile file = xmlTag.getContainingFile();
        // æ£€æŸ¥æ˜¯å¦æ˜¯testç›®å½•ä¸‹çš„xmlæ–‡ä»¶ï¼Œå¹¶ä¸”çˆ¶ç›®å½•æ˜¯å¦ä¸ºArtistçˆ¶çº§æ ‡ç­¾
        if (!(file instanceof XmlFile && isInTestDirectory(file) && isInArtistTag(xmlTag))) {
            return;
        }

        Set<ArtistXmlTag> tags = generateTags();
        for (ArtistXmlTag tag : tags) {
            // æ„å»ºLookupElementæ ‡ç­¾å…ƒç´ 
            LookupElement element = LookupElementBuilder
                    // æ ‡ç­¾åç§°
                    .create(tag.tagName)
                    // æŒ‡å®šæ’å…¥æ ‡ç­¾çš„Handler
                    .withInsertHandler(XmlTagInsertHandler.INSTANCE)
                    // æ ‡ç­¾æè¿°
                    .withTypeText(tag.tagDescription)
                    // è‡ªåŠ¨å®Œæˆ
                    .withAutoCompletionPolicy(AutoCompletionPolicy.ALWAYS_AUTOCOMPLETE);
            // åŠ å…¥åˆ°List<LookupElement>å°±èƒ½æ˜¾ç¤ºäº†
            list.add(element);
        }

    }

    private boolean isInArtistTag(XmlTag xmlTag) {
        // è·å¾—å½“å‰æ ‡ç­¾çš„çˆ¶çº§æ ‡ç­¾
        XmlTag parentTag = xmlTag.getParentTag();
        if (parentTag == null) return false;
        String parentTagName = parentTag.getName();
        return !TextUtils.isEmpty(parentTagName) &&
                (parentTagName.contains("ArtistLayout") || parentTagName.contains("ArtGroup"));
    }

    private Set<ArtistXmlTag> generateTags() {
        Set<ArtistXmlTag> tags = new HashSet<>();
        tags.add(new ArtistXmlTag("ArtView", "ç±»ä¼¼äºView"));
        tags.add(new ArtistXmlTag("ArtText", "æ–‡å­—æ§ä»¶ï¼Œç±»ä¼¼äºTextView"));
        tags.add(new ArtistXmlTag("ArtImage", "å›¾ç‰‡æ§ä»¶ï¼Œç±»ä¼¼äºImageView"));
        tags.add(new ArtistXmlTag("ArtGroup", "ç”¨äºç»„åˆArtistæ§ä»¶å…ƒç´ ï¼Œç±»ä¼¼ä¸ViewGroup"));
        return tags;
    }

    private boolean isInTestDirectory(PsiFile file) {
        file = file.getOriginalFile();
        // è·å¾—åŒ…å«è¯¥æ–‡ä»¶çš„æ–‡ä»¶å¤¹
        PsiDirectory dir = file.getContainingDirectory();
        if (dir == null) return false;
        final String dirName = dir.getName();
        return dirName.equals("test");
    }

}

```

## 2.2 æ³¨å†Œ XmlTagNameProvider æ‰©å±•

å®ç°å¥½äº† XmlTagNameProvider åï¼Œè¿˜éœ€è¦åˆ° `plugin.xml` ä¸­æ³¨å†Œä¸€ä¸‹ã€‚  

```
  <extensions defaultExtensionNs="com.intellij">
    // æ³¨å†Œä¸Šé¢å®ç°çš„ XmlTagNameProvider 
    <xml.tagNameProvider implementation="SimpleXmlTagNameProvider"/>
  </extensions>
```

å¥½äº†ï¼Œè¿è¡Œèµ·æ¥çœ‹çœ‹æ•ˆæœå¦‚ä½•ã€‚  

![](https://gw.alicdn.com/tfs/TB1Ym4aoAyWBuNjy0FpXXassXXa-526-322.gif)  

# 3. è®©Xmlç¼–è¾‘å™¨èƒ½å¤Ÿæç¤ºè‡ªå®šä¹‰å±æ€§

æŒ‰ç…§ä¸Šé¢çš„è·¯å­ï¼Œè¦å®ç°æç¤ºè‡ªå®šä¹‰å±æ€§ï¼Œè‡ªç„¶ä¹Ÿéœ€è¦ä¸€ä¸ª Provider æ¥æä¾›å†…å®¹ã€‚åœ¨ä¸Šè¿°é¡µé¢ä¸­æœ€ç»ˆé”å®š `XmlAttributeDescriptorsProvider` å’Œ `XmlElementDescriptorProvider` è¿™ä¸¤ä¸ªæ‰©å±•ç‚¹ã€‚è¿™é‡Œæ¨èä½¿ç”¨ `XmlElementDescriptorProvider` ï¼Œå®ƒæ›´åŠ çµæ´»ï¼Œå½“ç„¶è¦å†™çš„ä»£ç ä¹Ÿä¼šå¤šä¸€äº›ã€‚è€Œ`XmlAttributeDescriptorsProvider` ç»å®æµ‹æ˜¯ä¸å¤ªå¥½ç”¨çš„ã€‚  

æ¥ä¸‹æ¥ï¼Œè¿˜æ˜¯ä¸Šé¢çš„æµç¨‹ï¼Œè®©æˆ‘ä»¬æ¥å®ç°è¿™æ ·çš„åŠŸèƒ½ï¼šæŒ‡å®šçš„å±æ€§åªåœ¨æŒ‡å®šçš„æ ‡ç­¾å†…ç”Ÿæ•ˆï¼Œä¸åŒå±æ€§èƒ½å¤Ÿæç¤ºç‰¹æœ‰çš„æšä¸¾å€¼ã€‚  

## 3.1 å®ç°XmlElementDescriptorProvideræ¥å£
åœ¨æ³¨å†Œè¯¥æ‰©å±•åï¼Œæ¯å½“æˆ‘ä»¬ç¼–è¾‘xmlæ–‡ä»¶ï¼Œå°±ä¼šè§¦å‘ `getDescriptor()` è°ƒç”¨ï¼Œå¹¶ä¸”èƒ½å¤Ÿè·å–å½“å‰ç¼–è¾‘çš„æ˜¯å“ªä¸ªæ ‡ç­¾ã€‚

```
public class SimpleElementDescriptorProvider implements XmlElementDescriptorProvider {

    @Override
    public XmlElementDescriptor getDescriptor(XmlTag xmlTag) {
        String tagName = xmlTag.getName();
        // å¦‚æœæ˜¯Artistç³»æ ‡ç­¾æ‰è¿›è¡Œå¤„ç†
        if (isArtistTag(tagName)) {
            // éœ€è¦è¿”å›ä¸€ä¸ª XmlElementDescriptor ç”¨äºæè¿°æç¤ºå†…å®¹
            return new SimpleElementDescriptor(tagName, xmlTag);
        }
        return null;
    }

    private boolean isArtistTag(String tagName) {
        return tagName.contains("ArtView") || tagName.contains("ArtText")
                || tagName.contains("ArtImage") || tagName.contains("ArtGroup");
    }
}
```

## 3.2 å®ç°xmlå…ƒç´ æè¿°å¯¹è±¡ XmlElementDescriptor 
XmlElementDescriptor è¢«ç”¨äºæè¿°ä¸€ä¸ªxmlå…ƒç´ ä¿¡æ¯ã€‚åœ¨å®ç° XmlElementDescriptorProvider æ¥å£æ—¶ï¼Œæˆ‘ä»¬è®© `getDescriptor()` å‡½æ•°è¿”å›è‡ªå·±å®šåˆ¶çš„xmlå…ƒç´ æè¿°å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ XmlElementDescriptor ã€‚å®ƒå®šä¹‰äº†å¾ˆå¤šæ¥å£ä¾›ç”¨æˆ·å®ç°ï¼Œä»¥æè¿°ä¸€ä¸ªxmlå…ƒç´ çš„ä¿¡æ¯ã€‚è¿™é‡Œåªéœ€è¦å…³æ³¨æœ€ä¸»è¦çš„ä¸¤ä¸ªæ¥å£å°±è¡Œã€‚  

```
public class SimpleElementDescriptor implements XmlElementDescriptor {

    private XmlTag xmlTag;
    private String tagName = "";

    public SimpleElementDescriptor(String tagName, XmlTag xmlTag) {
        this.tagName = tagName;
        this.xmlTag = xmlTag;
    }
    
    ...

    @Override
    public XmlAttributeDescriptor[] getAttributesDescriptors(@Nullable XmlTag xmlTag) {
    
        // æä¾›ä¸€ç»„å¯ä¾›é€‰æ‹©çš„å±æ€§ï¼Œæ¯ä¸ªå±æ€§ç”¨XmlAttributeDescriptoræè¿°
        
        XmlAttributeDescriptor[] descriptors = {new SimpleAttrDescriptor("art_gravity", xmlTag)
                , new SimpleAttrDescriptor("art_layout_width", xmlTag)
                , new SimpleAttrDescriptor("art_id", xmlTag)

        };
        return descriptors;
    }

    @Nullable
    @Override
    public XmlAttributeDescriptor getAttributeDescriptor(XmlAttribute xmlAttribute) {
        // å½“ä¸€ä¸ªå±æ€§éœ€è¦èµ‹å€¼æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
        // æ­¤æ—¶èƒ½å¤Ÿè·å¾—å½“å‰å±æ€§å¯¹è±¡xmlAttribute
    
        String attributeName = xmlAttribute.getName();
        if (attributeName.contains(":")) {
            int start = attributeName.indexOf(':') + 1;
            if (start <= attributeName.length()) {
                attributeName = attributeName.substring(start);
            }
        }
        return new SimpleAttrDescriptor(attributeName, xmlTag);
    }
    
    ...
}

```  

åœ¨å®ç° XmlElementDescriptor çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›ä¸€äº›ç”¨äºæè¿°å±æ€§çš„å¯¹è±¡ XmlAttributeDescriptor ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªéœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°çš„æ¥å£ï¼Œå’Œ XmlElementDescriptor å·®ä¸å¤šã€‚  

## 3.3 å®ç°xmlå±æ€§æè¿°å¯¹è±¡ XmlAttributeDescriptor  

XmlAttributeDescriptor è¢«ç”¨äºæè¿°ä¸€ä¸ªxmlå±æ€§ä¿¡æ¯ã€‚è¿™ä¸ªæ¥å£ä¹Ÿæœ‰å¾ˆå¤šå‡½æ•°éœ€è¦å®ç°ï¼ŒåŒæ ·è¿™é‡Œåªå…³æ³¨æœ€ä¸»è¦çš„å‡ ä¸ªå‡½æ•°çš„å®ç°ã€‚  

```
public class SimpleAttrDescriptor implements XmlAttributeDescriptor {
    private XmlTag xmlTag;
    private String attrName;

    public SimpleAttrDescriptor(String attributeName, XmlTag xmlTag) {
        this.xmlTag = xmlTag;
        this.attrName = attributeName;
    }
    
    ...

    @Override
    public String getName(PsiElement psiElement) {
        // å½“éœ€è¦æç¤ºå±æ€§æ—¶ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°
        // è¿™é‡Œæˆ‘ä»¬éœ€è¦è¿”å›æœ€ç»ˆçš„æç¤ºå†…å®¹
        // æˆ‘æŠŠå‘½åç©ºé—´é™å®šä¸ºäº†app
        
        if (attrName.contains("app:")) {
            return attrName;
        }
        return "app:" + attrName;
    }

    @Override
    public String getName() {
        // è¿”å›å±æ€§åç§°
        return attrName;
    }

    @Override
    public boolean isEnumerated() {
        // ä¼šè¢«è°ƒç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªæšä¸¾å±æ€§
        // å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šæç¤ºæ‰€æœ‰å¯ç”¨çš„å€¼
        final String[] enumeratedValues = getEnumeratedValues();
        return !ArrayUtil.isEmpty(enumeratedValues);
    }

    @Override
    public String[] getEnumeratedValues() {
        // éœ€è¦æä¾›å±æ€§å¯ç”¨çš„æšä¸¾å€¼
        List<String> values = new ArrayList<>();
        if (getName().equals("art_gravity")) {
            values.add("left");
            values.add("top");
            values.add("right");
            values.add("bottom");
            values.add("center");
        } else if (getName().equals("art_layout_width")) {
            values.add("dp");
            values.add("sp");
        }
        return ArrayUtil.toStringArray(values);
    }

    ...
}

```

## 3.4 æ³¨å†ŒXmlElementDescriptorProvideræ‰©å±•
æœ€åä¸€æ­¥æ€»æ˜¯æ³¨å†Œã€‚  

```
  <extensions defaultExtensionNs="com.intellij">
    <xml.elementDescriptorProvider implementation="SimpleElementDescriptorProvider"/>
  </extensions>
```  

è¿è¡Œæ’ä»¶ï¼Œæ•ˆæœå³å¯å‘ˆç°ï¼  

![](https://gw.alicdn.com/tfs/TB16GMsoDtYBeNjy1XdXXXXyVXa-620-510.gif)  

# æ€»ç»“
æœ¬ç¯‡å®æˆ˜æ˜¯ä»¥æˆ‘å¼€å‘çš„ Artist UIåº“çš„é…å¥—æ’ä»¶çš„ä¸ºä¾‹çš„ï¼Œé‡ç‚¹ä¸æ˜¯å¦‚ä½•å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼IntelliJ æä¾›äº†å¾ˆå¤š **æ‰©å±•ç‚¹** ï¼Œæ¯ä¸ªæ‰©å±•ç‚¹éƒ½æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚å¾ˆå¤šæ‰©å±•ç‚¹è¯¥å¦‚ä½•ä½¿ç”¨ï¼Œåœ¨ç½‘ç»œä¸Šå‡ ä¹å¾ˆéš¾æ‰¾åˆ°æ•™ç¨‹ï¼ŒGoogleä¹Ÿä¸è¡Œï¼  

æœ¬ç¯‡çš„é‡ç‚¹æ˜¯æˆ‘ä»¬è¯¥ä»ä½•å…¥æ‰‹ï¼Œå¼€å§‹ç”¨é™Œç”Ÿçš„Apiç»„ç»‡é€»è¾‘ï¼Œå®ç°é¢„æœŸçš„æ’ä»¶åŠŸèƒ½ã€‚æœ¬ç¯‡æ‰€å®ç°çš„æ’ä»¶åŠŸèƒ½å°±æ˜¯ç”¨ä¸‹é¢è¿™ä¸ªå¥—è·¯å®Œæˆï¼š  

1. æ‰“å¼€[ã€æµ·é‡çš„æ’ä»¶æ‰©å±•ç‚¹ä½ã€‘](https://upsource.jetbrains.com/idea-ce/structure/idea-ce-d00d8b4ae3ed33097972b8a4286b336bf4ffcfab/platform/platform-resources/src/META-INF)  
2. æ ¹æ®éœ€è¦æŠ½è±¡å…³é”®å­—ï¼Œåœ¨ä¸Šè¿°é¡µé¢ä¸­æœç´¢ç›¸å…³æ‰©å±•ç‚¹ã€‚æ ¹æ®æ‰©å±•ç‚¹åç§°å¯»æ‰¾ç¬¦åˆçš„æ‰©å±•ç‚¹ã€‚
3. é€šè¿‡æ‰©å±•ç‚¹æ¥å£åæœç´¢ä½¿ç”¨çš„åœ°æ–¹ï¼Œç¡®å®šæ˜¯å¦èƒ½å®ç°é¢„æœŸåŠŸèƒ½ï¼Œå¹¶ä¸”å­¦ä¹ å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ‰©å±•ç‚¹ã€‚

