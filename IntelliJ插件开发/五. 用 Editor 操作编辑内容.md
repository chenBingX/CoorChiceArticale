# äº”. ç”¨ Editor æ“ä½œç¼–è¾‘å†…å®¹
é€šè¿‡ Editor æˆ‘ä»¬å¯ä»¥æ“ä½œ IDEA ä¸­çš„å¯ç¼–è¾‘å¯¹è±¡ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰“å¼€çš„æ¯ä¸€ä¸ªä»£ç ç¼–è¾‘çª—å£ï¼Œæˆ–è€…xmlç¼–è¾‘çª—å£ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ª Editor å®ä¾‹ã€‚  

ä½†ä»ç„¶éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼Œæ“ä½œæ‰æ˜¯å¯ç”¨çš„ï¼š
- æœ‰ä¸€ä¸ªæ‰“å¼€çš„é¡¹ç›®ã€‚
- æœ‰ä¸€ä¸ªå¯ç”¨çš„ Editor å¯¹è±¡ã€‚
- é€‰ä¸­ Editor ä¸­çš„å†…å®¹ã€‚

# 1. å¦‚ä½•è·å–Editor
1.é€šè¿‡ AnActionEvent è·å–  

```
public class SimpleAction extends AnAction {

    @Override
    public void actionPerformed(AnActionEvent e) {
        Editor editor = e.getData(CommonDataKeys.EDITOR);
        ...
    }
}
```

2.é€šè¿‡ DataContext è·å–

```
Editor editor = CommonDataKeys.EDITOR.getData(context);
```

3.é€šè¿‡ Project å¯¹è±¡è·å–

```
FileEditorManager.getInstance(project).getSelectedTextEditor();
```

# 2. å¦‚ä½•ä½¿ç”¨Editor
åœ¨è·å–åˆ°Editorå¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°ä»»ä½•çš„ç¼–è¾‘ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶çš„åˆ›å»ºã€æ–‡æœ¬çš„é€‰æ‹©ã€æ–‡æœ¬å˜åŒ–ã€æ»šåŠ¨æ–‡æœ¬...ç‰¹åˆ«å¤šçš„ä¿¡æ¯ã€‚  

æˆ‘ä»¬å¯ä»¥é€šè¿‡Editorè·å–åˆ°ä¸åŒçš„æ“ä½œæ¨¡å‹ï¼Œé€šè¿‡è¿™äº›æ¨¡å‹è¿›è¡Œç›‘å¬å¹¶è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚  

```
public class SimpleAction extends AnAction {
    @Override
    public void actionPerformed(AnActionEvent e) {
        Editor editor = e.getData(CommonDataKeys.EDITOR);
        // é€‰æ‹©æ¨¡å‹-å¯ä»¥è·å–é€‰ä¸­çš„æ–‡æœ¬ä¿¡æ¯
        SelectionModel selectionModel = editor.getSelectionModel();
        // åˆ›å»ºæ¨¡å‹-å¯è·å–å…‰æ ‡ä¿¡æ¯
        CaretModel caretModel = editor.getCaretModel();
        // æŠ˜å æ¨¡å‹-å¯ä»¥è·å–æŠ˜å å†…å®¹çš„ä¿¡æ¯
        FoldingModel foldingModel = editor.getFoldingModel();
        // ç¼©è¿›æ¨¡å‹-å¯ä»¥è·å–åˆ°ç¼©è¿›ä¿¡æ¯
        IndentsModel indentsModel = editor.getIndentsModel();
        // æ»šåŠ¨æ¨¡å‹-å¯ä»¥è·å–åˆ°æ»šåŠ¨ä¿¡æ¯
        ScrollingModel scrollingModel = editor.getScrollingModel();
        // è½¯åŒ…æ¨¡å‹-æš‚æ—¶ä¸çŸ¥é“æ˜¯å¹²å˜›çš„
        SoftWrapModel softWrapModel = editor.getSoftWrapModel();
        // è·å–åˆ°æ–‡æœ¬å†…å®¹ä¿¡æ¯
        Document document = editor.getDocument();
    }
}
```

## 2.1 SelectionModel 
é€šè¿‡è¿™ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°å½“å‰é€‰ä¸­çš„å†…å®¹çš„ç›¸å…³ä¿¡æ¯ã€‚  

è¿™æ˜¯ä¸€ä¸ªæ —å­ğŸŒ°ã€‚  

```
public class SimpleAction extends AnAction {

    @Override
    public void actionPerformed(AnActionEvent e) {
        Editor editor = e.getData(CommonDataKeys.EDITOR);
        // é€‰æ‹©æ¨¡å‹-å¯ä»¥è·å–é€‰ä¸­çš„æ–‡æœ¬ä¿¡æ¯
        SelectionModel selectionModel = editor.getSelectionModel();
        // è®¾ç½®é€‰æ‹©ç›‘å¬
        selectionModel.addSelectionListener(new SelectionListener() {
            @Override
            public void selectionChanged(SelectionEvent selectionEvent) {
                // è·å–é€‰å–çš„èŒƒå›´
                TextRange textRange = selectionEvent.getNewRange();
                // å–å¾—å½“å‰ç¼–è¾‘å¯¹è±¡çš„å†…å®¹
                Document document = editor.getDocument();
                // æ ¹æ®é€‰å–èŒƒå›´è·å¾—ç›¸åº”æ–‡æœ¬
                String selectedText = document.getText(textRange);
                if (!TextUtils.isEmpty(selectedText)) {
                    // åˆ›å»ºä¸€ä¸ªé€šçŸ¥å±•ç¤ºæ•ˆæœ
                    Notifications.Bus.notify(
                            new Notification("simple-notification"
                                    , "å½“å‰é€‰æ‹©çš„å†…å®¹"
                                    , selectedText
                                    , NotificationType.INFORMATION));
                }
            }
        });
    }
}

```

![](https://gw.alicdn.com/tfs/TB18F21neuSBuNjy1XcXXcYjFXa-1440-960.gif)  

åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬ç›‘å¬äº† **SelectionModel**ï¼Œè¿™æ ·æ¯å½“é€‰æ‹©æ–‡æœ¬æ—¶ï¼Œå°±èƒ½è§¦å‘å›è°ƒã€‚å¹¶ä¸”ï¼Œé€šè¿‡å›è°ƒä¸­çš„ **SelectionEvent** å¯¹è±¡å¯è·å¾—é€‰æ‹©æ–‡æœ¬ä¿¡æ¯ã€‚  

## 2.2 CreateModel
é€šè¿‡ç»™ CreateModel æ·»åŠ ç›‘å¬ï¼Œå½“å…‰æ ‡ä¿¡æ¯å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šå¾—åˆ°å›è°ƒã€‚

```
public class SimpleAction extends AnAction {

    @Override
    public void actionPerformed(AnActionEvent e) {
        Editor editor = e.getData(CommonDataKeys.EDITOR);
        // åˆ›å»ºæ¨¡å‹-å¯è·å–å…‰æ ‡ä½ç½®çš„ä¿¡æ¯
        CaretModel caretModel = editor.getCaretModel();
        caretModel.addCaretListener(new CaretListener() {
            @Override
            public void caretPositionChanged(CaretEvent e) {
                // å…‰æ ‡ä½ç½®å‘ç”Ÿæ”¹å˜æ—¶å›è°ƒ
            }
        });
    }
}
```
åœ¨å›è°ƒä¸­è·å¾—çš„ **CaretEvent** å¯ä»¥è·å¾—è®¸å¤šè¯¦ç»†çš„å…‰æ ‡ä½ç½®ä¿¡æ¯ã€‚  

## 2.3 FoldingModel
é€šè¿‡ FoldingModel å¯ä»¥è·å¾—æŠ˜å ä»£ç ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æ“ä½œä»£ç è¿›è¡ŒæŠ˜å ã€‚

## 2.4 IndentsModel
é€šè¿‡ IndentsModel å¯ä»¥è·å¾—ç¼–è¾‘æ¡†çš„ä»£ç ç¼©è¿›ä¿¡æ¯ï¼Œå¹¶æ“ä½œç¼©è¿›ã€‚

## 2.5 ScrollingModel
é€šè¿‡ ScrollingModel å¯ä»¥ç›‘å¬ç¼–è¾‘æ¡†çš„æ»šåŠ¨äº‹ä»¶ï¼Œè·å¾—å½“å‰å¯è§†åŒºåŸŸã€‚

## 2.6 Document
Document å¯¹è±¡åŒ…å«äº†ç¼–è¾‘æ¡†å†…çš„æ–‡æœ¬ä¿¡æ¯ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥è·å¾—ç¼–è¾‘æ¡†ä¸­çš„æ–‡æœ¬å†…å®¹ï¼ŒåŒæ—¶å¯ä»¥ç›‘å¬æ–‡æœ¬çš„å˜åŒ–ã€‚é€šè¿‡ Document å¯¹è±¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ“ä½œä¿®æ”¹ç¼–è¾‘æ¡†ä¸­çš„å†…å®¹ã€‚  

```
public class SimpleAction extends AnAction {

    @Override
    public void actionPerformed(AnActionEvent e) {
        Editor editor = e.getData(CommonDataKeys.EDITOR);
        // è·å–åˆ°æ–‡æœ¬å†…å®¹ä¿¡æ¯
        Document document = editor.getDocument();
        document.addDocumentListener(new DocumentListener() {
            @Override
            public void documentChanged(DocumentEvent event) {
                // ç¼–è¾‘æ¡†å†…å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶å›è°ƒ
                
                // è·å–ç¼–è¾‘æ¡†å†…çš„æ–‡æœ¬å†…å®¹
                String content = document.getText();
            }
        });
    }
}
```
ä¸Šé¢ä»£ç ç»™å½“å‰çš„ Editor å¯¹è±¡æ·»åŠ äº†ä¸€ä¸ªç›‘å¬ï¼Œå½“å®ƒçš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šå›è°ƒã€‚ç®€å•è¯´ï¼Œå°±æ˜¯å½“å‰æ‰“å¼€çš„ç¼–è¾‘çª—å£ä¸­çš„ä»£ç å‘ç”Ÿäº†ä¿®æ”¹ï¼Œå°±è§¦å‘å›è°ƒã€‚

# 3. ActionHandler - äº‹ä»¶å¤„ç†
åœ¨ IntelliJ æ’ä»¶çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ActionHandler æ¥è¿›è¡Œä¸€äº›äº‹ä»¶çš„å¤„ç†ã€‚

## 3.1 å¤„ç†æŒ‰é”®äº‹ä»¶
é€šè¿‡ TypedActionHandler å¯ä»¥å¤„ç†æŒ‰é”®äº‹ä»¶ã€‚  

```
public class SimpleTypedHandler implements TypedActionHandler {

    @Override
    public void execute(@NotNull Editor editor, char c, @NotNull DataContext dataContext) {
        if (c == 'z') {
            final Document document = editor.getDocument();
            Project project = editor.getProject();
            Runnable runnable = new Runnable() {
                @Override
                public void run() {
                    document.insertString(0, "Typed\n");
                }
            };
            // æ‰§è¡Œå†™å…¥æ“ä½œ
            WriteCommandAction.runWriteCommandAction(project, runnable);
        }
    }
}

```

å®ç° TypedActionHandler æ¥å£ï¼Œåœ¨ `execute()`  ä¸­å¯ä»¥è·å–è§¦å‘äº‹ä»¶æ—¶ï¼Œå½“å‰æ‰“å¼€çš„ Editor å¯¹è±¡ï¼Œä»¥åŠè§¦å‘äº‹ä»¶çš„æŒ‰é”®å€¼ã€‚  

ä¸Šé¢çš„ä»£ç åœ¨äº‹ä»¶è§¦å‘æ—¶ï¼Œä¼šåˆ¤æ–­æ˜¯å¦ç‚¹å‡»çš„æ˜¯ "z" é”®ï¼Œå¦‚æœæ˜¯å°±åœ¨å½“å‰æ–‡ä»¶çš„0ä½ç½®åŠ ä¸Šå­—ç¬¦ä¸²â€œTypedâ€ã€‚  

å…‰å†™ä¸ªHandlerå¯ä¸èƒ½å¤Ÿæ¥å—åˆ°è§¦å‘äº‹ä»¶ï¼Œè¿˜éœ€è¦æ³¨å†Œã€‚  

æ³¨å†Œéœ€è¦é€šè¿‡ EditorActionManager æ¥è¿›è¡Œã€‚  

```
// è·å¾—actionç®¡ç†
EditorActionManager instance = EditorActionManager.getInstance();
// è·å¾—æŒ‰é”®äº‹ä»¶
TypedAction typedAction = instance.getTypedAction();
// è®¾ç½®æŒ‰é”®äº‹ä»¶çš„å¤„ç†è€…ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„å¤„ç†è€…
typedAction.setupHandler(new SimpleTypedHandler());
```

## 3.2 è·å–ç³»ç»Ÿçš„Handlerå¤„ç†äº‹ä»¶

é€šè¿‡ EditorActionManager å¯ä»¥è·å–åˆ°ç³»ç»Ÿçš„ EditorActionHandlerï¼Œé€šè¿‡å®ƒä»¬å¯ä»¥è¿›è¡Œç‰¹å®šçš„å¤„ç†ã€‚  

```
final Editor editor = anActionEvent.getRequiredData(CommonDataKeys.EDITOR);
EditorActionManager actionManager = EditorActionManager.getInstance();
// è·å–åˆ°CloneCaretActionHandler
EditorActionHandler actionHandler = actionManager.getActionHandler(IdeActions.ACTION_EDITOR_CLONE_CARET_BELOW);
```

å¦‚ä½•è§¦å‘è¿™ä¸ªHandlerå‘¢ï¼Ÿ  

```
public class SimpleAction extends AnAction {
    @Override
    public void actionPerformed(@NotNull AnActionEvent anActionEvent) {
        final Editor editor = anActionEvent.getRequiredData(CommonDataKeys.EDITOR);
        EditorActionManager actionManager = EditorActionManager.getInstance();
        EditorActionHandler actionHandler = actionManager.getActionHandler(IdeActions.ACTION_EDITOR_CLONE_CARET_BELOW);
        // æ‰§è¡ŒHandler
        actionHandler.execute(editor, editor.getCaretModel().getCurrentCaret(), anActionEvent.getDataContext());
    }
}
```

IntelliJ æä¾›äº†å¾ˆå¤šé¢„è®¾çš„ EditorActionHandlerï¼Œä½ å¯ä»¥åœ¨è¿™æ‰¾åˆ°å®ƒä»¬ï¼Œä»¥åŠå®ƒä»¬çš„ç”¨æ³•ã€‚  

[ã€IdeActions APIã€‘:http://grepcode.com/file/repository.grepcode.com/java/ext/com.jetbrains/intellij-idea/13.0.0/com/intellij/openapi/actionSystem/IdeActions.java#IdeActions](http://grepcode.com/file/repository.grepcode.com/java/ext/com.jetbrains/intellij-idea/13.0.0/com/intellij/openapi/actionSystem/IdeActions.java#IdeActions)  

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ç»§æ‰¿ EditorActionHandler å®ç°è¿›è¡Œè‡ªå·±çš„æ“ä½œã€‚  

```
public class SimpleEditorHandler extends EditorActionHandler {
    @Override
    protected void doExecute(@NotNull Editor editor, @Nullable Caret caret, DataContext dataContext) {
        // do something
    }
}
```




